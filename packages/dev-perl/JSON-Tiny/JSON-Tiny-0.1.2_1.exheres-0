# Copyright 2011 William Orr <will@worrbase.com>
# Distributed under the terms of the GNU General Public License v2

SUMMARY="Perl6 JSON parser"

HOMEPAGE="http://search.cpan.org/dist/${MY_PN:-${PN}}/"
DOWNLOADS="mirror://cpan/authors/id/M/MO/MORITZ/${MY_PNV:-${PNV}}.tar.gz"
BUGS_TO="will@worrbase.com"
REMOTE_IDS="cpan:${MY_PN:-${PN}}"
UPSTREAM_CHANGELOG="http://search.cpan.org/dist/${MY_PNV:-${PNV}}/Changes"

SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS=""

LICENCES="Artistic"

BUGS_TO="will@worrbase.com"

DEFAULT_SRC_PREPARE_PATCHES=( -p1 "${FILES}/JSON-Tiny-Configure.patch" )

RESTRICT="test"

DEPENDENCIES="
    build+run:
        dev-lang/rakudo:=
        dev-lang/parrot[>=3.0.0]
"

src_configure() {
    export PERL6LIB="/usr/lib64/parrot/3.0.0-devel/languages/perl6/lib"
    export RAKUDO_DIR="/usr/lib64/parrot/3.0.0-devel/languages/perl6"
    PARROT_DIR=$(which parrot)
    export PARROT_DIR=${PARROT_DIR%parrot}

    if [[ -f Configure ]]; then
        edo perl6 Configure
    fi
}

src_install() {
    PERL6LIB="${IMAGE}/usr/lib64/parrot/3.0.0-devel/languages/perl6/lib"
    JSON="${PERL6LIB}/JSON"
    TINY="${PERL6LIB}/Tiny"
    mkdir -p ${TINY}
    for lib in Tiny.pir Tiny.pm; do
        install "${WORK}/lib/JSON/${lib}" "${JSON}/${lib}"
    done

    for lib in Actions.pir Actions.pm Grammar.pm Grammar.pir; do
        install "${WORK}/lib/JSON/Tiny/${lib}" "${TINY}/${lib}"
    done
}
